<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Blendo v3.4 • Gestor de Recetas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="manifest" href="./manifest.json">

  <style>
    :root{
      --bg:#f7f3ef;
      --text:#111827;
      --muted:#4b5563;
      --muted2:#374151;
      --muted3:#6b7280;
      --card:#ffffff;
      --border:#e5e7eb;
      --shadow:0 10px 30px rgba(2,6,23,0.06);
      --primary:#0ea5e9; /* Azul cielo */
      --primary-hover:#0284c7;
      --green:#16a34a;
      --green-700:#15803d;
      --red:#dc2626;
      --red-700:#b91c1c;
      --btn:#111827;
      --btn-hover:#0f172a;
      --font-display: 'Inter', ui-sans-serif, system-ui;
    }
    html[data-theme="dark"]{
      --bg:#0f172a;
      --text:#e5e7eb;
      --muted:#cbd5e1;
      --muted2:#e2e8f0;
      --muted3:#94a3b8;
      --card:#1e293b;
      --border:#334155;
      --shadow:0 10px 30px rgba(0,0,0,0.35);
      --btn:#e5e7eb;
      --btn-hover:#cbd5e1;
      --primary:#38bdf8;
      --primary-hover:#0ea5e9;
    }

    html,body{ background:var(--bg); color:var(--text); margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; -webkit-font-smoothing: antialiased; height: 100%; }
    .container{ max-width: 1100px; margin: 0 auto; padding: 12px; box-sizing: border-box; display: flex; flex-direction: column; height: 100vh; }
    .card{ border-radius: 12px; border:1px solid var(--border); padding:16px; background:var(--card); box-shadow: var(--shadow); transition: all .2s; }
    .grid{ display:grid; gap:12px; }
    .grid-2{ grid-template-columns: repeat(2,minmax(0,1fr)); }
    .grid-3{ grid-template-columns: repeat(3,minmax(0,1fr)); }
    .grid-4{ grid-template-columns: repeat(4,minmax(0,1fr)); }
    .grid-5{ grid-template-columns: repeat(5,minmax(0,1fr)); }
    @media (max-width: 900px){ .grid-3{ grid-template-columns: repeat(2,1fr); } .grid-5{ grid-template-columns: repeat(3,1fr); } }
    @media (max-width: 640px){ .grid-2,.grid-3,.grid-4,.grid-5{ grid-template-columns: 1fr; } }
    .row{ display:flex; align-items:center; gap:8px; }
    .row-between{ display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:8px 14px; border-radius:12px; font-weight:600; border:1px solid var(--border); background:var(--card); color:var(--btn); cursor:pointer; transition:.2s; }
    .btn:hover{ background:#f3f4f6; border-color: #d1d5db; }
    html[data-theme="dark"] .btn:hover{ background: #334155; }
    .btn--solid{ background:var(--btn); color:#fff; border-color:transparent; }
    .btn--solid:hover{ background:var(--btn-hover); }
    .btn--primary{ background:var(--primary); color:#fff; border-color:transparent; }
    .btn--primary:hover{ background:var(--primary-hover); }
    .btn--ghost{ background:transparent; border-color:transparent; }
    .btn--ghost:hover{ background: #f3f4f6; }
    html[data-theme="dark"] .btn--ghost:hover{ background: #334155; }
    .btn--green{ background:var(--green); color:#fff; border-color:transparent; }
    .btn--green:hover{ background:var(--green-700); }
    .btn--red{ background:var(--red); color:#fff; border-color:transparent; }
    .btn--red:hover{ background:var(--red-700); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }
    .btn--sm { padding: 4px 10px; font-size: 13px; }

    input, select, textarea{ background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:12px; padding:8px 12px; width:100%; box-sizing:border-box; font-family:inherit; font-size:15px; }
    textarea{ resize: vertical; min-height: 80px; }
    .muted{ color:var(--muted); } .muted2{ color:var(--muted2); } .muted3{ color:var(--muted3); }
    .tag-warn{ background:#fef3c7; color:#92400e; padding:4px 10px; border-radius:12px; border:1px solid #fde68a; font-size:12px; }
    html[data-theme="dark"] .tag-warn{ background:#3a2d0b; color:#facc15; border-color:#4d3b0d; }

    .step{ display:flex; justify-content: space-between; align-items: center; border:1px solid var(--border); border-radius:8px; padding:6px 10px; background:var(--bg); opacity:.7; transition: all .2s; }
    .step--cur{ border-width:2px; border-color:var(--primary); opacity:1; background:var(--card); transform: scale(1.02); }
    .step--instruction{ background: #e0f2fe; border-color: var(--primary); opacity:1; }
    html[data-theme="dark"] .step--instruction{ background: #0c4a6e; }
    
    .cat{ display:flex; align-items:center; justify-content:center; font-weight:700; font-size:18px; padding:24px; border-radius:28px; border:1px solid rgba(0,0,0,.08); box-shadow: var(--shadow); transition:.2s; color:#fff; cursor:pointer; }
    .cat:hover{ transform: translateY(-2px); box-shadow: 0 15px 35px rgba(2,6,23,0.1); }
    .cat--smoothies{ background:#10b981; } .cat--milkshake{ background:#92400e; } .cat--syrups{ background:#a21caf; } .cat--raynex{ background:#334155; } .cat--clean{ background:#0284c7; }
    .pill{ font-size:11px; padding:2px 6px; border-radius:8px; border:1px solid var(--border); }
    .bg-red-50{background-color: #ffe4e6;} .text-red{color: #9f1239;}
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    h1, .h1{ font-size: 24px; margin:0; font-weight: 800; }
    h2, .h2{ font-size:18px; margin:0; font-weight: 700; } h3, .h3{ font-size:16px; margin:0; font-weight: 700; }
    .mt-2{ margin-top:8px; } .mt-3{ margin-top:12px; } .mt-4{ margin-top:16px; } .mb-2{ margin-bottom:8px; } .mb-3{ margin-bottom:12px; } .mb-4{ margin-bottom:16px; }

    .display-value{ font-family: var(--font-display); font-size: clamp(3rem, 7vw, 4rem); font-weight: 800; line-height: 1; margin: 2px 0; color: var(--primary); }
    .display-label{ font-family: var(--font-display); font-size: clamp(1.4rem, 3.5vw, 2rem); font-weight: 700; }
    .process-grid{ display: grid; grid-template-columns: 2.2fr 1fr; gap: 16px; flex-grow: 1; overflow: hidden; }
    @media (max-width: 900px) { .process-grid{ grid-template-columns: 1fr; } }
    .progress-ring { transform: rotate(-90deg); }
    .progress-ring__circle { transition: 0.35s stroke-dashoffset; stroke: var(--primary); }
    .checkbox-container { display: flex; align-items: center; gap: 10px; padding: 10px; background-color: var(--bg); border-radius: 12px; }
    .checkbox-container input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--primary); }
    .checkbox-container label { font-weight: 600; font-size: 14px; }
    
    .steps-container {
        background: var(--bg);
        border-radius: 12px;
        padding: 8px;
        overflow-y: auto;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .main-content {
      flex-grow: 1;
      overflow-y: auto;
    }
  </style>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <button id="install-button" style="display: none; position: fixed; top: 10px; left: 10px; z-index: 1000; padding: 12px; font-size: 16px; background-color: #16a34a; color: white; border: none; border-radius: 8px; cursor: pointer;">Instalar App</button>
  <noscript>Necesitás habilitar JavaScript para usar Blendo.</noscript>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect, useRef } = React;

    const Icons = { 
        back: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>, 
        restart: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L20.5 10a9 9 0 01-14.85 3.36L3.5 15"/></svg>, 
        fullscreen: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/></svg>, 
        sun: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>, 
        moon: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>, 
        soundOn: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 010 14.14M15.54 8.46a5 5 0 010 7.07"/></svg>, 
        soundOff: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>,
        plus: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>, 
        edit: <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>, 
        copy: <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>, 
        trash: <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
    };

    const useLocalStorage = (key, initial) => { 
        const [v,setV] = useState(()=>{ 
            try{
                const raw=localStorage.getItem(key); 
                return raw?JSON.parse(raw):initial;
            } catch {
                return initial;
            } 
        }); 
        useEffect(()=>{ 
            try {
                localStorage.setItem(key, JSON.stringify(v));
            } catch(e) {
                console.error("Error al escribir en LocalStorage", e);
            } 
        },[key,v]); 
        return [v,setV]; 
    };

    const useTheme = () => { const [dark,setDark] = useLocalStorage("theme.dark", false); useEffect(()=>{ document.documentElement.setAttribute("data-theme", dark?"dark":"light"); },[dark]); return [dark,setDark]; };
    
    const clampPercentages = (arr) => { const total = arr.reduce((a,b)=>a+(b.percent||0),0); if (total<=0) return arr; return arr.map(i=>({...i, percent: i.percent*100/total})); };
    const fmtKg = (kg)=> new Intl.NumberFormat("es-AR",{maximumFractionDigits:3}).format(kg)+" kg";
    const fmtGr = (g)=> new Intl.NumberFormat("es-AR",{maximumFractionDigits:0}).format(Math.round(g))+" g";
    const mmss = (s)=>{ const m=Math.floor(s/60), ss=s%60; return `${String(m).padStart(2,"0")}:${String(ss).padStart(2,"0")}`; };
    const nowISO = ()=> new Date().toISOString();
    const OPERATORS = ["Operario 1", "Operario 2", "Operario 3", "Admin"];
    const audio = { ctx: null, enabled: true, ensure(){ try{ if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); if (this.ctx.state === "suspended") this.ctx.resume(); }catch{} return this.ctx; }, beep({freq=880, duration=0.2, type="sine", volume=0.2}={}){ if(!this.enabled) return; const ctx = this.ensure(); if(!ctx) return; const o = ctx.createOscillator(); const g = ctx.createGain(); o.type = type; o.frequency.value = freq; g.gain.value = 0; o.connect(g); g.connect(ctx.destination); const t = ctx.currentTime; g.gain.setTargetAtTime(volume, t, 0.005); g.gain.setTargetAtTime(0.0001, t + Math.max(0, duration-0.05), 0.03); o.start(t); o.stop(t + duration + 0.05); }, chime(){ this.beep({freq:880, duration:0.12}); setTimeout(()=>this.beep({freq:660, duration:0.16}), 140); } };
    const Card = ({children, className="", style, ...props}) => <div className={`card ${className}`} style={style} {...props}>{children}</div>;
    const Btn = ({children, onClick, disabled, variant, color, className="", style, icon}) => { const base = "btn"; const palette = color === "primary" ? "btn--primary" : color === "green" ? "btn--green" : color === "red" ? "btn--red" : variant === "solid" ? "btn--solid" : (variant === "ghost" ? "btn--ghost" : ""); const handle = (e) => { try { audio.ensure(); } catch {} onClick && onClick(e); }; return <button onClick={handle} disabled={disabled} className={`${base} ${palette} ${className}`} style={style}>{icon}{children}</button>; };
    const useCountdown = (initial, auto=false) => { const [r,setR] = useState(initial); const [run,setRun] = useState(auto); useEffect(()=>{ if(!run||r<=0) return; const id = setInterval(()=>setR(x=>x>0?x-1:0),1000); return ()=>clearInterval(id); },[run,r]); return { remaining:r, running:run, done:r<=0, start:()=>setRun(true), pause:()=>setRun(false), reset:(sec=initial)=>{ setRun(false); setR(sec); } }; };
    
    const PHASES = ["MAYORITARIO", "MINORITARIO", "CLAVE"];

    const DEFAULT_DATA = [ 
      { category:"Smoothies", flavors:[
          { flavor:"Limón (Limonada Cremosa)", ingredients:[ 
              { name:"Maltodextrina", percent:45.0, phase:"MAYORITARIO" }, 
              { name:"Azúcar Impalpable", percent:37.0, phase:"MAYORITARIO" }, 
              { name:"Limón en Polvo", percent:12.0, phase:"CLAVE", sieve:true }, 
              { name:"Goma Xantana", percent:3.5, phase:"MINORITARIO", sieve:true }, 
              { name:"Ácido Cítrico", percent:2.0, phase:"MINORITARIO", sieve:true },
              { name:"Saborizante Limón", percent:0.3, phase:"MINORITARIO" }, 
              { name:"Sal Fina", percent:0.2, phase:"MINORITARIO" },
            ] 
          },
        ]
      }, 
      { category:"Milkshake", flavors:[
          { flavor:"Licuado de Banana Clásico", ingredients:[ 
              { name:"Leche en Polvo Entera", percent:45.0, phase:"MAYORITARIO", allergen:true },
              { name:"Azúcar Impalpable", percent:25.0, phase:"MAYORITARIO" },
              { name:"Banana en Polvo", percent:25.0, phase:"CLAVE", sieve:true },
              { name:"Maltodextrina", percent:3.0, phase:"MAYORITARIO" },
              { name:"Goma Xantana", percent:1.8, phase:"MINORITARIO", sieve:true },
              { name:"Sal Fina", percent:0.2, phase:"MINORITARIO" },
            ]
          },
          { flavor:"Dulce de Leche (con Proteína)", ingredients:[ 
              { name:"Proteína de Suero WPC35", percent:50.0, phase:"CLAVE", allergen:true },
              { name:"Leche en Polvo Entera", percent:15.0, phase:"MAYORITARIO", allergen:true },
              { name:"Azúcar Impalpable", percent:8.0, phase:"MAYORITARIO" },
              { name:"Saborizante Dulce de Leche", percent:25.0, phase:"MINORITARIO" },
              { name:"Goma Xantana", percent:1.8, phase:"MINORITARIO", sieve:true },
              { name:"Sal Fina", percent:0.2, phase:"MINORITARIO" },
            ]
          },
        ]
      }, 
      { category:"Syrups", flavors:[] }, 
      { category:"Raynex", flavors:[] }, 
      { category:"Limpieza", flavors:[] },
    ];

    function App(){
      const [dark,setDark] = useTheme();
      const [sound, setSound] = useLocalStorage("sound.on", true);
      useEffect(()=>{ audio.enabled = !!sound; },[sound]);
      const playDone = ()=>{ if(sound) audio.chime(); };

      const [data, setData] = useLocalStorage("recipes.v3.4", DEFAULT_DATA);
      const [batches, setBatches] = useLocalStorage("batches.v1", []);
      
      const [screen, setScreen] = useState("operator_select");
      const [operator, setOperator] = useState("");
      const [category, setCategory] = useState(null);
      const [flavor, setFlavor] = useState(null);
      const [recipeToEdit, setRecipeToEdit] = useState(null);
      
      const MIN_KG = 40;
      const MAX_KG = 80;
      const [kg, setKg] = useState(MIN_KG);

      const selCat = useMemo(()=>data.find(c=>c.category===category),[data,category]);
      const flavors = selCat?.flavors ?? [];
      const recipe = useMemo(()=>flavors.find(f=>f.flavor===flavor),[flavors,flavor]);

      const steps = useMemo(()=>{
        if(!recipe) return [];
        const total = kg*1000;
        const seq = [];
        const allIngredients = clampPercentages(recipe.ingredients).map(i => ({...i, grams: i.percent / 100 * total}));
        const mayoritarios = allIngredients.filter(i => i.phase === 'MAYORITARIO').sort((a,b)=>b.grams-a.grams);
        const minoritarios = allIngredients.filter(i => i.phase === 'MINORITARIO').sort((a,b)=>b.grams-a.grams);
        const clave = allIngredients.filter(i => i.phase === 'CLAVE').sort((a,b)=>b.grams-a.grams);
        const mainBulkingAgent = mayoritarios.length > 0 ? mayoritarios[0] : null;
        const otherMayoritarios = mainBulkingAgent ? mayoritarios.slice(1) : [];
        const mapToStep = (i, customName) => ({ type: 'add', phase: i.phase, ingredient: customName || i.name, grams: i.grams, sieve: i.sieve, allergen: i.allergen, note: i.note });
        if(mainBulkingAgent){ seq.push(mapToStep({ ...mainBulkingAgent, grams: mainBulkingAgent.grams / 2, phase: 'CAMA' }, `${mainBulkingAgent.name} (50%)`)); }
        otherMayoritarios.forEach(i => seq.push(mapToStep(i)));
        if(minoritarios.length > 0){ seq.push({ type: 'instruction', text: 'En un recipiente aparte, PRE-MEZCLAR y TAMIZAR los siguientes ingredientes finos ANTES de añadirlos a la máquina.' }); }
        minoritarios.forEach(i => seq.push(mapToStep(i)));
        clave.forEach(i => seq.push(mapToStep(i)));
        if(mainBulkingAgent){ seq.push(mapToStep({ ...mainBulkingAgent, grams: mainBulkingAgent.grams / 2, phase: 'TAPA' }, `${mainBulkingAgent.name} (50% restante)`)); }
        seq.push({ type:"mix", phase:'MEZCLADO', sec:240, info:`Mezclado de incorporación inicial (4 min).` });
        seq.push({ type:"mix", phase:'MEZCLADO', sec:1080, info:`Mezclado de homogeneización final (18 min).` });
        return seq;
      },[recipe,kg]);

      const [idx,setIdx] = useState(0);
      const cur = steps[idx];
      const [taraOk, setTaraOk] = useState(false);
      const [ingOk, setIngOk] = useState(false);
      const c = useCountdown(cur?.type==="mix" ? cur.sec : 0);
      useEffect(()=>{ setTaraOk(false); setIngOk(false); if(cur?.type==="mix") c.reset(cur.sec); else c.reset(0); },[idx,recipe]);
      const canNext = cur ? (cur.type==="add" ? taraOk && ingOk : (cur.type === 'instruction' ? true : c.done)) : false;

      const doneBeepRef = useRef(false);
      useEffect(()=>{ doneBeepRef.current = false; }, [idx, recipe]);
      useEffect(()=>{ if (cur?.type==="mix" && c.done && !doneBeepRef.current){ doneBeepRef.current = true; playDone(); } }, [cur?.type, c.done, idx]);
      const [done,setDone] = useState(false);
      const [batchId,setBatchId] = useState(null);
      const [notes, setNotes] = useState("");

      const next = ()=>{ if(!canNext) return; if(idx < steps.length-1) setIdx(i=>i+1); else { const id = `L${new Date().toISOString().replace(/[-:T.]/g,"").slice(0,12)}`; setBatchId(id); setDone(true); } };
      const reset = ()=>{ setScreen("mode"); setCategory(null); setFlavor(null); setKg(MIN_KG); setIdx(0); setIngOk(false); setTaraOk(false); setDone(false); setNotes(""); setRecipeToEdit(null); };
      const hardReset = ()=>{ reset(); setOperator(""); setScreen("operator_select"); };
      
      const consumos = useMemo(()=>{ if(!recipe) return []; const total=kg*1000; const norm=clampPercentages(recipe.ingredients); return norm.map(i=>({ insumo:i.name, qty_g: i.percent/100*total })); },[recipe,kg]);
      const registrar = ()=>{
        if(!batchId || !recipe || !category) return;
        const newB = { id:batchId, date: nowISO(), category, flavor:recipe.flavor, qty_kg:kg, consumptions:consumos, operator, notes };
        setBatches(p=>[newB,...p]);
        alert("✅ Lote registrado."); reset();
      };
      
      const toggleFull = ()=>{ if (!document.fullscreenElement) document.documentElement.requestFullscreen?.().catch(()=>{}); else document.exitFullscreen?.().catch(()=>{}); };
      
      const handleSaveRecipe = (savedRecipe, originalFlavor, originalCategory) => {
        setData(currentData => {
          let newData = JSON.parse(JSON.stringify(currentData));
          
          const cleanRecipe = { ...savedRecipe };
          delete cleanRecipe.isNew;
          delete cleanRecipe.originalFlavor;
          delete cleanRecipe.originalCategory;

          if (!savedRecipe.isNew) {
            const oldCatIdx = newData.findIndex(c => c.category === originalCategory);
            if (oldCatIdx > -1) {
              newData[oldCatIdx].flavors = newData[oldCatIdx].flavors.filter(f => f.flavor !== originalFlavor);
            }
          }

          let newCatIdx = newData.findIndex(c => c.category === cleanRecipe.category);
          if (newCatIdx === -1) {
            newData.push({ category: cleanRecipe.category, flavors: [cleanRecipe] });
          } else {
            newData[newCatIdx].flavors.push(cleanRecipe);
          }
          return newData;
        });
        setScreen("manage_recipes");
        setRecipeToEdit(null);
      };

      if (screen === "operator_select") {
        return <OperatorSelect onSelect={op => { setOperator(op); setScreen("mode"); }} />;
      }
      if (screen === "manage_recipes") {
        return <ManageRecipesScreen data={data} setData={setData} setScreen={setScreen} setRecipeToEdit={setRecipeToEdit} operator={operator} />;
      }
      if (screen === "edit_recipe") {
        return <RecipeEditor recipeToEdit={recipeToEdit} onSave={handleSaveRecipe} onCancel={() => { setScreen("manage_recipes"); setRecipeToEdit(null); }} />;
      }

      if (screen === "process" && recipe) {
        return (
          <div className="container" style={{display: 'flex', flexDirection: 'column', height: '100vh', padding: '12px'}}>
            <header className="mb-2">
              <div className="row-between">
                <div className="row">
                  <Btn variant="ghost" icon={Icons.back} onClick={()=>setScreen("quantity")}>Atrás</Btn>
                  <h2 className="h2">{category} • {recipe.flavor} • {fmtKg(kg)}</h2>
                </div>
                <div className="muted" style={{fontSize: 14}}>Paso <b>{idx+1}</b>/{steps.length}</div>
              </div>
            </header>
            <div className="process-grid">
              <Card style={{display: 'flex', flexDirection:'column', justifyContent:'space-between'}}>
                {cur.type === "add" && (
                  <div>
                    <div className="muted">{cur.phase}</div>
                    <div className="display-label">{cur.ingredient}</div>
                    <div className="display-value">{fmtGr(cur.grams)}</div>
                    {cur.allergen && <span className="pill bg-red-50 text-red">ALÉRGENO</span>}
                    {cur.sieve && <div className="muted3 mt-2" style={{fontSize: 13}}>💡 Recomendación: <b>tamizar</b> este ingrediente antes de añadirlo.</div>}
                  </div>
                )}
                {cur.type === "mix" && (
                  <div style={{textAlign: "center"}}>
                    <div className="display-label">Mezclar</div>
                    <CircularTimer remaining={c.remaining} total={cur.sec} />
                    <div className="muted3 mb-2" style={{fontSize: 13}}>{cur.info}</div>
                    <div className="row" style={{justifyContent:"center"}}>
                      {!c.running ? <Btn onClick={c.start}>▶️ Iniciar</Btn> : <Btn onClick={c.pause}>⏸️ Pausar</Btn>}
                      <Btn variant="ghost" onClick={()=>c.reset(cur.sec)}>Reiniciar</Btn>
                    </div>
                  </div>
                )}
                {cur.type === "instruction" && (
                  <div style={{display:'flex', flexDirection:'column', justifyContent:'center', alignItems:'center', textAlign:'center', height:'100%'}}>
                    <div style={{fontSize: 48}}>✋</div>
                    <h3 className="mt-3">Instrucción Importante</h3>
                    <p className="muted">{cur.text}</p>
                  </div>
                )}
                <div>
                  {cur.type === "add" && (
                    <div className="grid mt-3" style={{gap:8}}>
                        <div className="checkbox-container">
                          <input type="checkbox" id="tara" checked={taraOk} onChange={e=>setTaraOk(e.target.checked)} />
                          <label htmlFor="tara">Balanza en CERO / TARA</label>
                        </div>
                        <div className="checkbox-container">
                          <input type="checkbox" id="ing" checked={ingOk} onChange={e=>setIngOk(e.target.checked)} disabled={!taraOk}/>
                          <label htmlFor="ing">Ingrediente añadido CORRECTAMENTE</label>
                        </div>
                    </div>
                  )}
                  <Btn onClick={next} disabled={!canNext} color="primary" style={{width: '100%', padding: '12px', marginTop: '12px', fontSize:'16px'}}>
                    {cur.type==='instruction' ? 'Entendido, continuar' : (idx+1 < steps.length ? "Siguiente Paso" : "Finalizar Proceso")}
                  </Btn>
                </div>
              </Card>
              <div style={{display:'flex', flexDirection:'column', minHeight: 0}}>
                <h3 className="mb-2">Plan de Mezcla Sándwich</h3>
                <div className="steps-container">
                    <div className="grid" style={{gap:6}}>
                      {steps.map((s,i)=>{
                        const isCur = i===idx;
                        const isInstruction = s.type === 'instruction';
                        const cls = isCur ? "step step--cur" : "step";
                        return (
                          <div key={i} className={`${cls} ${isInstruction && 'step--instruction'}`}>
                            <div className="row" style={{gap: '10px'}}>
                                <b style={{minWidth:'20px', textAlign:'center'}}>{i+1}.</b>
                                <span style={{fontWeight: isCur ? 700:500, fontSize:14, flexGrow:1, whiteSpace: 'nowrap', overflow:'hidden', textOverflow:'ellipsis'}}>
                                    {s.type==="add" ? s.ingredient : (s.type === 'mix' ? 'MEZCLAR' : 'INSTRUCCIÓN')}
                                </span>
                            </div>
                            <div className="muted mono" style={{fontSize:14, fontWeight: isCur ? 700:400}}>
                                {s.type==="add" ? fmtGr(s.grams) : (s.type === 'mix' ? mmss(s.sec) : '----')}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                </div>
              </div>
            </div>
            {done && ( <Card style={{position:'fixed', top:'50%', left:'50%', transform:'translate(-50%, -50%)', zIndex:100, width:'90%', maxWidth:'600px'}}> <h3 className="mb-2">Registrar lote</h3> <div className="muted mb-3">Lote: <span className="mono">{batchId}</span> • Receta: <b>{recipe.flavor}</b> • Cantidad: <b>{fmtKg(kg)}</b></div> <div> <h3 className="mb-2">Notas (Opcional)</h3> <textarea value={notes} onChange={e=>setNotes(e.target.value)} placeholder="Ej: La materia prima estaba compactada..."></textarea> </div> <div className="row" style={{justifyContent:"flex-end", marginTop:16}}> <Btn variant="ghost" onClick={reset}>Cancelar</Btn> <Btn color="green" onClick={registrar}>Registrar y Salir</Btn> </div> </Card> )}
          </div>
        );
      }
      
      return (
        <div className="container">
           <header className="mb-4">
            <div className="row-between">
              <div className="row">
                <img src="./logo.png" alt="Blendo" style={{height:"32px", width:"auto"}} onError={(e)=>{e.target.style.display='none'}} />
                <h1 style={{fontSize: 18}}>Blendo</h1>
              </div>
              <div className="row" style={{flexWrap:"wrap"}}>
                <Btn icon={Icons.fullscreen} onClick={toggleFull} />
                <Btn icon={dark? Icons.sun : Icons.moon} onClick={()=>setDark(v=>!v)} />
                <Btn icon={sound? Icons.soundOn : Icons.soundOff} onClick={()=>setSound(v=>!v)} />
                <Btn icon={Icons.restart} variant="ghost" onClick={hardReset}>Salir</Btn>
              </div>
            </div>
            <div className="muted3 mt-2" style={{fontSize: 14}}>Operario: <b>{operator}</b></div>
          </header>
          <main className="main-content">
            {screen === "mode" && (
                <Card>
                  <div className="row-between mb-4">
                    <div>
                      <h2 className="mb-2">¿Qué querés preparar?</h2>
                      <div className="muted">Elegí una opción para comenzar.</div>
                    </div>
                    <Btn onClick={() => setScreen("manage_recipes")}>Gestionar Recetas</Btn>
                  </div>
                  <div className="grid grid-5">
                    <div className="cat cat--smoothies" onClick={()=>{ setCategory("Smoothies"); setScreen("flavor"); }}>Smoothies</div>
                    <div className="cat cat--milkshake" onClick={()=>{ setCategory("Milkshake"); setScreen("flavor"); }}>Milkshake</div>
                    <div className="cat cat--syrups" onClick={()=>{ setCategory("Syrups"); setScreen("flavor"); }}>Syrups</div>
                    <div className="cat cat--raynex" onClick={()=>{ setCategory("Raynex"); setScreen("flavor"); }}>Raynex</div>
                    <div className="cat cat--clean" onClick={()=>{ setCategory("Limpieza"); alert("Proceso no disponible"); }}>Limpieza</div>
                  </div>
                </Card>
            )}
            {screen === "flavor" && (
                <Card>
                  <div className="row mb-4">
                    <Btn variant="ghost" icon={Icons.back} onClick={()=>setScreen("mode")}>Atrás</Btn>
                    <h2 style={{fontWeight:600}}>Elegí el sabor ({category})</h2>
                  </div>
                  <div className="grid grid-3">
                    {(flavors ?? []).map(f=>(
                      <Card key={f.flavor} style={{padding:16, cursor:"pointer"}} onClick={()=>{ setFlavor(f.flavor); setScreen("quantity"); }}>
                        <div style={{fontWeight:600}}>{f.flavor}</div>
                        <div className="muted3 mt-2" style={{fontSize:14}}>Ingredientes: {f.ingredients.length}</div>
                      </Card>
                    ))}
                    {flavors.length === 0 && <div className="muted">No hay recetas en esta categoría.</div>}
                  </div>
                </Card>
            )}
            {screen === "quantity" && (() => {
                const handleKgChange = (e) => {
                    let val = e.target.value;
                    if (val === '') { setKg(''); return; }
                    val = parseFloat(val);
                    if (val > MAX_KG) val = MAX_KG;
                    setKg(val);
                };
                const handleBlur = (e) => {
                    let val = parseFloat(e.target.value);
                    if (isNaN(val) || val < MIN_KG) { setKg(MIN_KG); }
                };
                const isInvalid = kg === '' || kg < MIN_KG || kg > MAX_KG;
                return (
                    <Card>
                      <div className="row mb-4">
                        <Btn variant="ghost" icon={Icons.back} onClick={()=>setScreen("flavor")}>Atrás</Btn>
                        <h2>Definí la cantidad a preparar</h2>
                      </div>
                      <div className="grid grid-2" style={{alignItems:"flex-end"}}>
                        <div>
                          <div className="muted mb-2">Masa total (entre {MIN_KG} y {MAX_KG} kg)</div>
                          <div className="row" style={{gap:0}}>
                            <input type="number" min={MIN_KG} max={MAX_KG} step="0.1" value={kg} onChange={handleKgChange} onBlur={handleBlur} style={{borderColor: isInvalid ? 'var(--red)' : 'var(--border)'}} />
                            <Card style={{padding:"10px 12px", marginLeft:8, borderRadius:"0 12px 12px 0"}}>kg</Card>
                          </div>
                           {isInvalid && <div style={{color: 'var(--red)', fontSize:12, marginTop:4}}>La cantidad debe estar entre {MIN_KG} y {MAX_KG} kg.</div>}
                        </div>
                        <Card style={{background:'var(--bg)'}}>
                          <div className="muted">Resumen: <b>{flavor}</b></div>
                          <div style={{fontSize:18, fontWeight:700}}>{fmtKg(kg)}</div>
                        </Card>
                      </div>
                      <div className="mt-4" style={{display:"flex", justifyContent:"flex-end"}}>
                        <Btn onClick={()=>setScreen("process")} disabled={isInvalid || !flavor} color="primary">Comenzar Proceso</Btn>
                      </div>
                    </Card>
                );
            })()}
          </main>
        </div>
      );
    }

    const OperatorSelect = ({onSelect})=>{
      const [op,setOp] = useState("");
      return (
        <div style={{display:'flex', alignItems:'center', justifyContent:'center', minHeight:'100vh'}}>
          <Card style={{minWidth: 320, textAlign: 'center'}}>
            <img src="./logo.png" alt="Blendo" style={{height:"120px", width:"auto", marginBottom: 24}} onError={(e)=>{e.target.style.display='none'}} />
            <h2 className="mb-3">Bienvenido a Blendo</h2>
            <div className="muted mb-4">Seleccioná tu usuario para comenzar</div>
            <select value={op} onChange={e=>setOp(e.target.value)} className="mb-4">
              <option value="">-- Seleccionar Operario --</option>
              {OPERATORS.map(o=><option key={o} value={o}>{o}</option>)}
            </select>
            <Btn color="primary" onClick={()=>onSelect(op)} disabled={!op} style={{width:'100%'}}>Ingresar</Btn>
          </Card>
        </div>
      )
    };
    
    const CircularTimer = ({ remaining, total }) => {
      const size = 140; const strokeWidth = 10;
      const radius = (size - strokeWidth) / 2; const circumference = radius * 2 * Math.PI;
      const progress = total > 0 ? (total - remaining) / total : 0;
      const strokeDashoffset = circumference - progress * circumference;
      return (
        <div style={{ position: 'relative', width: size, height: size, margin: '12px auto' }}>
          <svg className="progress-ring" width={size} height={size}>
            <circle stroke="var(--border)" strokeWidth={strokeWidth} fill="transparent" r={radius} cx={size/2} cy={size/2} />
            <circle className="progress-ring__circle" strokeWidth={strokeWidth} strokeDasharray={circumference + ' ' + circumference} style={{ strokeDashoffset }} fill="transparent" r={radius} cx={size/2} cy={size/2} />
          </svg>
          <div className="mono" style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', fontSize: 32 }}>
            {mmss(remaining)}
          </div>
        </div>
      );
    };

    const ManageRecipesScreen = ({ data, setData, setScreen, setRecipeToEdit, operator }) => {
      const handleCreate = () => {
        setRecipeToEdit({
          isNew: true,
          category: 'Smoothies',
          flavor: 'Nueva Receta',
          ingredients: [{ name: '', percent: 100, phase: 'MAYORITARIO', sieve: false, allergen: false }],
        });
        setScreen('edit_recipe');
      };

      const handleEdit = (cat, flav) => {
        const recipe = data.find(c => c.category === cat)?.flavors.find(f => f.flavor === flav);
        if (recipe) {
          // BUG FIX: Añadir la categoría al objeto de la receta a editar
          setRecipeToEdit({ ...recipe, category: cat, isNew: false, originalFlavor: recipe.flavor, originalCategory: cat });
          setScreen('edit_recipe');
        }
      };

      const handleDuplicate = (cat, flav) => {
        const recipe = data.find(c => c.category === cat)?.flavors.find(f => f.flavor === flav);
        if (recipe) {
          setRecipeToEdit({
            ...JSON.parse(JSON.stringify(recipe)),
            category: cat, // Asegurarse de que la categoría esté presente
            isNew: true,
            flavor: `${recipe.flavor} (Copia)`,
          });
          setScreen('edit_recipe');
        }
      };
      
      const handleDelete = (cat, flav) => {
        if (window.confirm(`¿Estás seguro que querés borrar la receta "${flav}"? Esta acción no se puede deshacer.`)) {
          setData(currentData => {
            const newData = JSON.parse(JSON.stringify(currentData));
            const categoryIndex = newData.findIndex(c => c.category === cat);
            if (categoryIndex > -1) {
              newData[categoryIndex].flavors = newData[categoryIndex].flavors.filter(f => f.flavor !== flav);
            }
            return newData;
          });
        }
      };

      return (
        <div className="container">
          <header className="mb-4">
            <div className="row-between">
              <div className="row"><h1 style={{fontSize: 18}}>Gestor de Recetas</h1></div>
              <div className="row"><div className="muted3 mt-2" style={{fontSize: 14}}>Operario: <b>{operator}</b></div></div>
            </div>
          </header>
          <main className="main-content">
            <div className="row-between mb-4">
              <Btn icon={Icons.back} onClick={() => setScreen("mode")}>Volver</Btn>
              <Btn icon={Icons.plus} color="primary" onClick={handleCreate}>Crear Nueva Receta</Btn>
            </div>
            <div className="grid" style={{gap: 24}}>
              {data.filter(c => c.flavors).map(cat => (
                <div key={cat.category}>
                  <h2 className="mb-3">{cat.category}</h2>
                  <div className="grid" style={{gap: 8}}>
                    {cat.flavors.map(flav => (
                      <Card key={flav.flavor} className="row-between">
                        <div>
                          <div style={{fontWeight: 600}}>{flav.flavor}</div>
                          <div className="muted3 mt-2" style={{fontSize: 13}}>{flav.ingredients.length} ingredientes</div>
                        </div>
                        <div className="row">
                          <Btn icon={Icons.edit} className="btn--sm" onClick={() => handleEdit(cat.category, flav.flavor)}>Editar</Btn>
                          <Btn icon={Icons.copy} className="btn--sm" onClick={() => handleDuplicate(cat.category, flav.flavor)}>Duplicar</Btn>
                          <Btn icon={Icons.trash} className="btn--sm btn--red" onClick={() => handleDelete(cat.category, flav.flavor)}></Btn>
                        </div>
                      </Card>
                    ))}
                    {cat.flavors.length === 0 && <div className="muted">No hay recetas en esta categoría.</div>}
                  </div>
                </div>
              ))}
            </div>
          </main>
        </div>
      );
    };

    const RecipeEditor = ({ recipeToEdit, onSave, onCancel }) => {
      const [recipe, setRecipe] = useState(JSON.parse(JSON.stringify(recipeToEdit)));
      
      const originalFlavor = recipeToEdit.isNew ? null : recipeToEdit.originalFlavor;
      const originalCategory = recipeToEdit.isNew ? null : recipeToEdit.originalCategory;

      const handleRecipeChange = (field, value) => {
        setRecipe(r => ({ ...r, [field]: value }));
      };
      
      const handleIngredientChange = (index, field, value) => {
        const newIngredients = [...recipe.ingredients];
        newIngredients[index][field] = value;
        if(field === 'percent') newIngredients[index][field] = parseFloat(value) || 0;
        if(field === 'sieve' || field === 'allergen') newIngredients[index][field] = !!value;
        setRecipe(r => ({ ...r, ingredients: newIngredients }));
      };
      
      const addIngredient = () => {
        const newIngredients = [...recipe.ingredients, { name: '', percent: 0, phase: 'MAYORITARIO', sieve: false, allergen: false }];
        setRecipe(r => ({ ...r, ingredients: newIngredients }));
      };

      const removeIngredient = (index) => {
        const newIngredients = recipe.ingredients.filter((_, i) => i !== index);
        setRecipe(r => ({ ...r, ingredients: newIngredients }));
      };
      
      const totalPercent = useMemo(() => recipe.ingredients.reduce((sum, ing) => sum + (ing.percent || 0), 0), [recipe.ingredients]);
      
      const handleSave = () => {
        if (!recipe.flavor || !recipe.flavor.trim() || !recipe.category || !recipe.category.trim()) {
          alert("El nombre del sabor y la categoría no pueden estar vacíos.");
          return;
        }
        if (recipe.ingredients.some(i => !i.name.trim())) {
          alert("Todos los ingredientes deben tener un nombre.");
          return;
        }
        onSave(recipe, originalFlavor, originalCategory);
      };

      return (
        <Card>
          <h2 className="mb-4">{recipeToEdit.isNew ? 'Crear Nueva Receta' : `Editando: ${originalFlavor}`}</h2>
          
          <div className="grid grid-2 mb-4">
            <div>
              <label className="muted" style={{fontSize: 14}}>Categoría</label>
              <input type="text" value={recipe.category} onChange={e => handleRecipeChange('category', e.target.value)} />
            </div>
            <div>
              <label className="muted" style={{fontSize: 14}}>Nombre del Sabor</label>
              <input type="text" value={recipe.flavor} onChange={e => handleRecipeChange('flavor', e.target.value)} />
            </div>
          </div>

          <h3 className="mb-3">Ingredientes</h3>
          <div className="grid" style={{gap: 8}}>
            {recipe.ingredients.map((ing, index) => (
              <Card key={index} style={{background: 'var(--bg)'}}>
                <div className="grid" style={{gridTemplateColumns: '3fr 1fr 1.5fr 1fr', gap: 8, alignItems: 'center'}}>
                  <input type="text" value={ing.name} placeholder="Nombre del Ingrediente" onChange={e => handleIngredientChange(index, 'name', e.target.value)} />
                  <div className="row">
                    <input type="number" step="0.01" value={ing.percent} onChange={e => handleIngredientChange(index, 'percent', e.target.value)} />
                    <span className="muted">%</span>
                  </div>
                  <select value={ing.phase} onChange={e => handleIngredientChange(index, 'phase', e.target.value)}>
                    {PHASES.map(p => <option key={p} value={p}>{p}</option>)}
                  </select>
                  <Btn icon={Icons.trash} color="red" onClick={() => removeIngredient(index)} />
                </div>
                <div className="row mt-2" style={{gap: 16}}>
                    <div className="checkbox-container" style={{padding:0, background:'transparent'}}>
                      <input type="checkbox" id={`sieve-${index}`} checked={!!ing.sieve} onChange={e => handleIngredientChange(index, 'sieve', e.target.checked)} />
                      <label htmlFor={`sieve-${index}`} style={{fontSize:13}}>Tamizar</label>
                    </div>
                    <div className="checkbox-container" style={{padding:0, background:'transparent'}}>
                      <input type="checkbox" id={`allergen-${index}`} checked={!!ing.allergen} onChange={e => handleIngredientChange(index, 'allergen', e.target.checked)} />
                      <label htmlFor={`allergen-${index}`} style={{fontSize:13}}>Alérgeno</label>
                    </div>
                </div>
              </Card>
            ))}
          </div>

          <div className="row-between mt-4">
             <Btn icon={Icons.plus} onClick={addIngredient}>Añadir Ingrediente</Btn>
             <div className={`h3 ${totalPercent.toFixed(2) !== '100.00' ? 'text-red' : ''}`}>
                Total: {totalPercent.toFixed(2)}%
                {totalPercent.toFixed(2) !== '100.00' && <span className="tag-warn" style={{marginLeft: 8}}>Debe sumar 100%</span>}
             </div>
          </div>
          
          <div className="row mt-4" style={{justifyContent: 'flex-end'}}>
            <Btn variant="ghost" onClick={onCancel}>Cancelar</Btn>
            <Btn color="green" onClick={handleSave}>Guardar Receta</Btn>
          </div>
        </Card>
      );
    };
    
    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>

  <script>
    let deferredPrompt;
    const installButton = document.getElementById('install-button');

    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('Evento beforeinstallprompt detectado!');
      e.preventDefault();
      deferredPrompt = e;
      installButton.style.display = 'block';
    });

    installButton.addEventListener('click', async () => {
      if (deferredPrompt) {
        console.log('Botón de instalación presionado. Mostrando diálogo...');
        installButton.style.display = 'none';
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`Respuesta del usuario: ${outcome}`);
        deferredPrompt = null;
      }
    });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').then(registration => {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, err => {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }
  </script>
</body>
</html>
